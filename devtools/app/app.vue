<script setup lang="ts">
import { onDevtoolsClientConnected } from '@nuxt/devtools-kit/iframe-client'
import type { ClientFunctions, ServerFunctions, Component } from '../../src/devtools/rpc'
import type { BirpcReturn } from 'birpc'
import { watchDebounced } from '@vueuse/core'
import type { DevtoolsMeta } from '../../src/runtime/composables/extendDevtoolsMeta'
import type { ComponentMeta } from 'vue-component-meta'

// Disable devtools in component renderer iframe
// @ts-expect-error - Nuxt Devtools internal value
window.__NUXT_DEVTOOLS_DISABLE__ = true

const components = useState<Array<Component & { value: string }>>('__ui-devtools-components')
const component = useState<Component | undefined>('__ui-devtools-component')
const state = useState<Record<string, any>>('__ui-devtools-state', () => ({}))

let rpc: BirpcReturn<ServerFunctions, ClientFunctions> | null = null

onDevtoolsClientConnected(async (client) => {
  rpc = client.devtools.extendClientRpc<ServerFunctions, ClientFunctions>('nuxt/ui/devtools', { })

  const componentMeta = await $fetch<Record<string, { meta: ComponentMeta & { devtools: DevtoolsMeta<any> } }>>('/api/component-meta')

  components.value = (await rpc.getComponents()).flatMap((component) => {
    if (componentMeta[component.slug]?.meta.devtools?.ignore) return []

    return [{
      ...component,
      value: component.slug,
      meta: componentMeta[component.slug]?.meta
    }]
  })

  if (!component.value || !components.value.find(c => c.slug === component.value?.slug)) {
    component.value = components.value.find(comp => comp.slug === 'accordion')
  }

  state.value.props = components.value?.reduce((acc, comp) => {
    const componentDefaultProps = comp.meta?.props.reduce((acc, prop) => {
      if (prop.default) acc[prop.name] = prop.default
      return acc
    }, {} as Record<string, any>)

    acc[comp.slug] = {
      ...comp.defaultVariants, // Default values from the theme template
      ...componentDefaultProps, // Default values from vue props
      ...componentMeta[comp.slug]?.meta?.devtools?.defaultProps // Default values from devtools extended meta
    }

    return acc
  }, {} as Record<string, any>)
})

const componentProps = computed(() => {
  if (!component.value) return
  return state.value.props[component.value?.slug]
})

const componentPropsMeta = computed(() => {
  return component.value?.meta?.props.filter(prop => prop.name !== 'ui').sort((a, b) => a.name.localeCompare(b.name))
})

function updateRenderer() {
  if (!component.value) return
  const event: Event & { data?: any } = new Event('nuxt-ui-devtools:update-renderer')
  event.data = {
    props: state.value.props?.[component.value.slug], slots: state.value.slots?.[component.value?.slug]
  }
  window.dispatchEvent(event)
}

watchDebounced(state, updateRenderer, { deep: true, debounce: 200, maxWait: 500 })
onMounted(() => window.addEventListener('nuxt-ui-devtools:component-loaded', onComponentLoaded))
onUnmounted(() => window.removeEventListener('nuxt-ui-devtools:component-loaded', onComponentLoaded))

function onComponentLoaded() {
  if (!component.value) return
  updateRenderer()
}

const tabs = computed(() => {
  if (!component.value) return
  return [
    { label: 'Props', slot: 'props', icon: 'i-heroicons-cog-6-tooth', disabled: !component.value.meta?.props?.length }
  ]
})

function openDocs() {
  if (!component.value) return
  window.parent.open(`https://ui3.nuxt.dev/components/${component.value.slug}`)
}

const colorMode = useColorMode()
const isDark = computed({
  get() {
    return colorMode.value === 'dark'
  },
  set(value) {
    colorMode.preference = value ? 'dark' : 'light'

    const event: Event & { isDark?: boolean } = new Event('nuxt-ui-devtools:set-color-mode')
    event.isDark = value
    window.dispatchEvent(event)
  }
})
</script>

<template>
  <UApp class="h-screen w-full relative font-sans">
    <div v-if="!components || !component" class="h-screen w-screen" />
    <template v-else>
      <div
        class="top-0 h-[49px] border-b border-[--ui-border] flex justify-center"
      >
        <span />

        <UInputMenu
          v-model="component"
          variant="none"
          :items="components"
          placeholder="Search component..."
          class="top-0 translate-y-0 w-full mx-2"
          icon="i-heroicons-magnifying-glass"
        />

        <div class="absolute top-[49px] bottom-0 inset-x-0 grid xl:grid-cols-8 grid-cols-4 bg-[--ui-bg]">
          <div class="col-span-1 border-r border-[--ui-border] hidden xl:block overflow-y-auto">
            <UNavigationMenu
              :items="components.map((c) => ({ ...c, select: () => component = c }))"
              orientation="vertical"
            />
          </div>

          <div class="xl:col-span-5 col-span-2 relative">
            <ComponentPreview :component="component" :props="componentProps" class="h-full" />
            <div class="flex gap-2 absolute top-1 right-2">
              <UButton
                :icon="isDark ? 'i-heroicons-moon-20-solid' : 'i-heroicons-sun-20-solid'"
                variant="ghost"
                color="neutral"
                @click="isDark = !isDark"
              />
              <UButton
                v-if="component"
                variant="ghost"
                color="neutral"
                icon="i-heroicons-arrow-top-right-on-square"
                @click="openDocs()"
              >
                Open docs
              </UButton>
            </div>
          </div>

          <div class="border-l border-[--ui-border] flex flex-col col-span-2 overflow-y-auto">
            <UTabs color="neutral" variant="link" :items="tabs" class="relative" :ui="{ list: 'sticky top-0 bg-[--ui-bg] z-50' }">
              <template #props>
                <div v-for="prop in componentPropsMeta" :key="'prop-' + prop.name" class="px-3 py-5 border-b border-[--ui-border] dark:border-[--ui-border]">
                  <ComponentPropInput v-bind="prop" v-model="componentProps[prop.name]" />
                </div>
              </template>
            </UTabs>
          </div>
        </div>
      </div>
    </template>
  </UApp>
</template>

<style>
@import 'tailwindcss';
@import '@nuxt/ui';

@theme {
  --font-family-sans: 'DM Sans', sans-serif;

  --color-primary-50: var(--ui-color-primary-50);
  --color-primary-100: var(--ui-color-primary-100);
  --color-primary-200: var(--ui-color-primary-200);
  --color-primary-300: var(--ui-color-primary-300);
  --color-primary-400: var(--ui-color-primary-400);
  --color-primary-500: var(--ui-color-primary-500);
  --color-primary-600: var(--ui-color-primary-600);
  --color-primary-700: var(--ui-color-primary-700);
  --color-primary-800: var(--ui-color-primary-800);
  --color-primary-900: var(--ui-color-primary-900);
  --color-primary-950: var(--ui-color-primary-950);

  --color-neutral-50: var(--ui-color-neutral-50);
  --color-neutral-100: var(--ui-color-neutral-100);
  --color-neutral-200: var(--ui-color-neutral-200);
  --color-neutral-300: var(--ui-color-neutral-300);
  --color-neutral-400: var(--ui-color-neutral-400);
  --color-neutral-500: var(--ui-color-neutral-500);
  --color-neutral-600: var(--ui-color-neutral-600);
  --color-neutral-700: var(--ui-color-neutral-700);
  --color-neutral-800: var(--ui-color-neutral-800);
  --color-neutral-900: var(--ui-color-neutral-900);
  --color-neutral-950: var(--ui-color-neutral-950);
}

:root {
  --ui-border: var(--ui-color-neutral-200);
  --ui-bg: white;
}

.dark {
  --ui-border: var(--ui-color-neutral-800);
  --ui-bg: var(--ui-color-neutral-900);
}
</style>
